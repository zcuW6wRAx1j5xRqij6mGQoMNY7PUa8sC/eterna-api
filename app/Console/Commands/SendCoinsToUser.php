<?php

namespace App\Console\Commands;

use App\Enums\FundsEnums;
use App\Enums\SpotWalletFlowEnums;
use App\Models\UserWalletSpot;
use App\Models\UserWalletSpotFlow;
use Illuminate\Console\Command;

class SendCoinsToUser extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'coins:send';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $data = [
            13 => '1000.00',
300 => '117720.00',
522 => '400000.00',
36 => '26260500.00',
17 => '39000000.00',
206 => '14276840.00',
23 => '242000.00',
524 => '298000.00',
221 => '5000000.00',
94 => '600000.00',
76 => '962000.00',
280 => '110000.00',
35 => '1860000.00',
69 => '8000000.00',
439 => '31680.00',
148 => '2844220.00',
151 => '3464879.00',
402 => '642010.00',
407 => '530000.00',
78 => '20500.00',
406 => '1377300.00',
79 => '800000.00',
55 => '24000.00',
152 => '1566000.00',
540 => '24000.00',
523 => '1653000.00',
89 => '1340000.00',
120 => '137360.00',
212 => '17105000.00',
41 => '3000000.00',
310 => '8081800.00',
287 => '22000.00',
101 => '284600.00',
43 => '98000.00',
216 => '220000.00',
399 => '246215.00',
122 => '3731330.00',
460 => '204320.00',
117 => '171200.00',
84 => '897200.00',
436 => '69290000.00',
26 => '25360.00',
37 => '1121000.00',
29 => '6247200.00',
134 => '6117440.00',
125 => '101240.00',
184 => '20000.00',
267 => '52000000.00',
4 => '1280000.00',
391 => '12000000.00',
390 => '2256.00',
162 => '196220.00',
508 => '26500.00',
103 => '30000.00',
360 => '5360.00',
561 => '131000.00',
16 => '1864412.00',
238 => '1400000.00',
320 => '33000.00',
61 => '22000.00',
153 => '40400.00',
119 => '1600000.00',
220 => '91500.00',
39 => '30904.00',
546 => '248320.00',
547 => '653420.00',
57 => '555310.00',
137 => '4000.00',
77 => '1300000.00',
449 => '140000.00',
121 => '193000.00',
201 => '116000.00',
476 => '21550000.00',
529 => '950000.00',
569 => '44000.00',
232 => '300000.00',
191 => '843060.00',
25 => '1700000.00',
68 => '3068000.00',
383 => '1900000.00',
73 => '227500.00',
340 => '8000.00',
182 => '2000.00',
186 => '1152160.00',
209 => '307240.00',
445 => '32000.00',
235 => '1093040.00',
149 => '1324410.00',
15 => '22262166.00',
46 => '47080.00',
387 => '60000.00',
27 => '2000.00',
532 => '20000.00',
193 => '39600.00',
33 => '57090.00',
58 => '157120.00',
308 => '1440000.00',
62 => '200000.00',
236 => '11370400.00',
63 => '300000.00',
514 => '4000.00',
111 => '42000.00',
571 => '502000.00',
187 => '3400000.00',
457 => '2000.00',
141 => '486010.00',
190 => '818240.00',
59 => '134000.00',
252 => '2206000.00',
118 => '216240.00',
51 => '1535000.00',
249 => '3970460.00',
463 => '324000.00',
374 => '600000.00',
497 => '87470.00',
502 => '64920.00',
512 => '31400.00',
487 => '52300.00',
258 => '4000.00',
74 => '139600.00',
293 => '689450.00',
516 => '20500.00',
498 => '5200.00',
521 => '1600000.00',
172 => '120000.00',
124 => '5171720.00',
492 => '41920.00',
500 => '180000.00',
573 => '104000.00',
42 => '300000.00',
422 => '13000.00',
435 => '16000.00',
454 => '5720.00',
128 => '1000000.00',
394 => '1670000.00',
45 => '2400000.00',
274 => '2040.00',
472 => '900000.00',
440 => '4000000.00',
104 => '1400000.00',
188 => '3200000.00',
517 => '4500.00',
568 => '312760.00',
241 => '12240.00',
139 => '2000000.00',
328 => '20000.00',
183 => '32000020.00',
369 => '1163840.00',
30 => '600000.00',
32 => '166400.00',
44 => '26000000.00',
14 => '22000000.00'
        ];

        $coinId = 525;
        
        foreach ($data as $uid=>$amount) {
            $targetWallet = UserWalletSpot::where('uid', $uid)->where('coin_id', $coinId)->lockForUpdate()->first();
            if (!$targetWallet) {
                $targetWallet = new UserWalletSpot();
                $targetWallet->uid = $uid;
                $targetWallet->coin_id = $coinId;
                $targetWallet->amount = 0;
                $targetWallet->save();
            }
    
            $beforeTargetBalance = $targetWallet->amount;
            $targetWallet->amount = bcadd($targetWallet->amount, $amount, FundsEnums::DecimalPlaces);
            $targetWallet->save();
    
            $flow = new UserWalletSpotFlow();
            $flow->uid = $uid;
            $flow->coin_id = $coinId;
            $flow->flow_type = SpotWalletFlowEnums::FlowTypeSystemDeposit;
            $flow->before_amount = $beforeTargetBalance;
            $flow->amount = $amount;
            $flow->after_amount = $targetWallet->amount;
            $flow->relation_id =0;
            $flow->save();
        }

        return $this->info('ok');
    }
}
