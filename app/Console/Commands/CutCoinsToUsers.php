<?php

namespace App\Console\Commands;

use App\Enums\CoinEnums;
use App\Enums\FundsEnums;
use App\Enums\SpotWalletFlowEnums;
use App\Exceptions\LogicException;
use App\Models\UserWalletSpot;
use App\Models\UserWalletSpotFlow;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;

class CutCoinsToUsers extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'app:cut-coins-to-users';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $data = [
            13 => '500.00',
300 => '5886.00',
17 => '50000.00',
206 => '713842.00',
23 => '12100.00',
524 => '14900.00',
221 => '250000.00',
94 => '30000.00',
76 => '48100.00',
280 => '5500.00',
35 => '93000.00',
69 => '400000.00',
439 => '1584.00',
148 => '142211.00',
151 => '173243.95',
402 => '32100.50',
407 => '26500.00',
78 => '1025.00',
406 => '68865.00',
79 => '40000.00',
55 => '1200.00',
152 => '78300.00',
540 => '1200.00',
523 => '82650.00',
120 => '6868.00',
36 => '381015.00',
212 => '855250.00',
41 => '150000.00',
310 => '404090.00',
287 => '1100.00',
101 => '14230.00',
43 => '4900.00',
216 => '11000.00',
399 => '12310.75',
122 => '186566.50',
460 => '10216.00',
117 => '8560.00',
84 => '44860.00',
26 => '1268.00',
37 => '56050.00',
29 => '312360.00',
134 => '305872.00',
125 => '5062.00',
184 => '1000.00',
267 => '2600000.00',
4 => '64000.00',
391 => '600000.00',
390 => '112.80',
162 => '9811.00',
508 => '1325.00',
103 => '1500.00',
360 => '268.00',
561 => '6550.00',
16 => '93220.60',
238 => '70000.00',
320 => '1650.00',
61 => '1100.00',
153 => '2020.00',
119 => '80000.00',
220 => '4575.00',
39 => '1545.20',
546 => '12416.00',
547 => '32671.00',
57 => '27765.50',
77 => '65000.00',
449 => '7000.00',
121 => '5900.00',
201 => '5800.00',
476 => '1077500.00',
436 => '464500.00',
569 => '2200.00',
232 => '15000.00',
191 => '42153.00',
25 => '85000.00',
68 => '153400.00',
383 => '95000.00',
73 => '11375.00',
340 => '400.00',
182 => '100.00',
186 => '57608.00',
209 => '15362.00',
445 => '1600.00',
235 => '54652.00',
149 => '66220.50',
15 => '1285981.30',
46 => '2354.00',
387 => '3000.00',
27 => '100.00',
532 => '1000.00',
193 => '1980.00',
33 => '2854.50',
58 => '7856.00',
308 => '72000.00',
62 => '10000.00',
236 => '568520.00',
63 => '15000.00',
514 => '200.00',
111 => '2100.00',
571 => '25100.00',
457 => '100.00',
141 => '24300.50',
190 => '40912.00',
59 => '6700.00',
252 => '110300.00',
118 => '10812.00',
51 => '76750.00',
249 => '198523.00',
463 => '16200.00',
89 => '65000.00',
374 => '30000.00',
497 => '4373.50',
502 => '3246.00',
512 => '1570.00',
187 => '140000.00',
487 => '2615.00',
258 => '200.00',
74 => '6980.00',
293 => '34472.50',
516 => '1025.00',
498 => '260.00',
137 => '100.00',
521 => '80000.00',
172 => '6000.00',
124 => '258586.00',
492 => '2096.00',
500 => '9000.00',
573 => '5200.00',
42 => '15000.00',
422 => '650.00',
435 => '800.00',
454 => '286.00',
128 => '50000.00',
394 => '83500.00',
45 => '120000.00',
274 => '102.00',
472 => '45000.00',
440 => '200000.00',
104 => '70000.00',
188 => '160000.00',
517 => '225.00',
568 => '15638.00',
241 => '612.00',
139 => '100000.00',
328 => '1000.00',
183 => '1600001.00',
369 => '58192.00',
30 => '30000.00',
32 => '8320.00',
44 => '1300000.00'
        ];

        foreach($data as $uid=>$usdt) {
            $targetWallet = UserWalletSpot::where('uid', $uid)->where('coin_id',CoinEnums::DefaultUSDTCoinID)->lockForUpdate()->first();
            if (!$targetWallet) {
                $this->error('uid'. $uid);
                throw new LogicException('没有钱包数据');
            }
    
            $d = bcsub($targetWallet->lock_amount, $usdt, FundsEnums::DecimalPlaces);
            if ($d < 0) {
                $this->error('uid'. $uid);
                Log::error('用户可用冻结资金不正确',[
                    'uid'=>$uid,
                    'lock_amount'=>$targetWallet->lock_amount,
                    'need_d'=>$usdt,
                ]);
                continue;
                // throw new LogicException('可用冻结资金不正确');
            }
            $targetWallet->lock_amount = $d;
            $targetWallet->save();
    
            // $flow = new UserWalletSpotFlow();
            // $flow->uid = $uid;
            // $flow->coin_id = CoinEnums::DefaultUSDTCoinID;
            // $flow->flow_type = SpotWalletFlowEnums::FlowTypeSystemDeposit;
            // $flow->before_amount = $beforeTargetBalance;
            // $flow->amount = - $usdt;
            // $flow->after_amount = $targetWallet->amount;
            // $flow->relation_id =0;
            // $flow->save();
        }
        return $this->info('ok');
    }
}
